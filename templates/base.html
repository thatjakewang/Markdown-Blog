<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}Jake Wang{% endblock %}</title>
    <meta name="description" content="{% block description %}Jake Wang's personal portfolio and blog about Data Science, Python, and Financial Modeling.{% endblock %}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <button id="theme-toggle" style="background:none; border:none; cursor:pointer; font-size:1.5rem; margin-left:10px; margin-right: 10px;" title="Toggle Theme">
                    â˜€ï¸
                </button>
                <a href="/">Jake Wang</a>
            </div>
            <nav>
                <a href="{{ url_for('blog') }}">Blog</a>

                <button onclick="openSearch()" style="background:none; border:none; cursor:pointer; font-size:1.2rem; margin-left:15px;" title="Search">
                    ğŸ”
                </button>
            </nav>
        </header>
        
        <main>
            {% block content %}{% endblock %}
        </main>

        <footer>
            <p>&copy; 2025 Jake Wang</p>
        </footer>
    </div>

    <div id="search-modal" class="search-modal" style="display: none;">
        <div class="search-content">
            <div class="search-header">
                <input type="text" id="search-input" placeholder="Type to search..." autocomplete="off">
                <button onclick="closeSearch()" class="close-btn">Ã—</button>
            </div>
            <div id="search-results" class="search-results-list"></div>
        </div>
    </div>

    <script>
        // --- Part A: æš—é»‘æ¨¡å¼é‚è¼¯ ---
        const toggleButton = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        
        const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
        
        if (currentTheme) {
            htmlElement.setAttribute('data-theme', currentTheme);
            if (currentTheme === 'dark') toggleButton.textContent = 'ğŸŒ™';
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            htmlElement.setAttribute('data-theme', 'dark');
            toggleButton.textContent = 'ğŸŒ™';
        }

        toggleButton.addEventListener('click', () => {
            if (htmlElement.getAttribute('data-theme') === 'dark') {
                htmlElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                toggleButton.textContent = 'â˜€ï¸';
            } else {
                htmlElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                toggleButton.textContent = 'ğŸŒ™';
            }
        });

        // --- Part B: å³æ™‚æœå°‹é‚è¼¯ (Client-Side Search) ---
        let allPosts = []; // ç”¨ä¾†æš«å­˜å¾ API æŠ“ä¸‹ä¾†çš„æ–‡ç« è³‡æ–™

        async function openSearch() {
            // é¡¯ç¤ºé®ç½©
            document.getElementById('search-modal').style.display = 'flex';
            // è®“æ¸¸æ¨™è‡ªå‹•è·³é€²è¼¸å…¥æ¡†
            document.getElementById('search-input').focus();
            
            // å¦‚æœé‚„æ²’æŠ“éè³‡æ–™ï¼Œæ‰å»å‘¼å«å¾Œç«¯ API
            if (allPosts.length === 0) {
                try {
                    // é€™è£¡ä½¿ç”¨ Jinja2 ç”¢ç”Ÿçš„ URLï¼Œè¨˜å¾—è¦ç”¨å¼•è™ŸåŒ…èµ·ä¾†
                    const response = await fetch("{{ url_for('get_posts_json') }}");
                    allPosts = await response.json();
                } catch (error) {
                    console.error("ç„¡æ³•å–å¾—æ–‡ç« è³‡æ–™:", error);
                }
            }
        }

        function closeSearch() {
            document.getElementById('search-modal').style.display = 'none';
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = '';
        }

        // ç›£è½è¼¸å…¥æ¡†çš„æ‰“å­—äº‹ä»¶
        document.getElementById('search-input').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = ''; // æ¸…ç©ºèˆŠçµæœ

            if (term.length < 1) return; // è‡³å°‘æ‰“1å€‹å­—æ‰æœå°‹

            // éæ¿¾è³‡æ–™ (æ¯”å°æ¨™é¡Œ)
            const filteredPosts = allPosts.filter(post => 
                post.title.toLowerCase().includes(term) || 
                post.date.includes(term) ||
                (post.description && post.description.toLowerCase().includes(term)) ||
                (post.body && post.body.toLowerCase().includes(term))
            );

            // é¡¯ç¤ºçµæœ
            if (filteredPosts.length === 0) {
                resultsContainer.innerHTML = '<div style="padding:15px; color:#999;">No results found</div>';
            } else {
                filteredPosts.forEach(post => {
                    const item = document.createElement('a');
                    item.href = post.url; // é€™è£¡çš„ url æ˜¯å¾ JSON ä¾†çš„ï¼Œä¸éœ€è¦ url_for
                    item.className = 'search-result-item';
                    let displayText = post.title;
                    let subText = post.date;
                    if (post.description && post.description.toLowerCase().includes(term)) {
                        subText += ` - ${post.description.substring(0, 50)}...`;
                    }

                    item.innerHTML = `
                        <span class="search-result-title">${post.title}</span>
                        <span class="search-result-date">${post.date}</span>
                    `;
                    resultsContainer.appendChild(item);
                });
            }
        });

        // é»æ“ŠåŠé€æ˜é»‘åº•èƒŒæ™¯æ™‚ï¼Œä¹Ÿè¦é—œé–‰è¦–çª—
        document.getElementById('search-modal').addEventListener('click', function(e) {
            if (e.target === this) closeSearch();
        });
        
        // æŒ‰ä¸‹ ESC éµé—œé–‰è¦–çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === "Escape") closeSearch();
        });

        document.getElementById('search-input').addEventListener('keypress', function(e) {
            // æª¢æŸ¥æŒ‰ä¸‹çš„æ˜¯å¦ç‚º Enter éµ (Key Code 13)
            if (e.key === 'Enter') {
                e.preventDefault(); // é˜²æ­¢æŸäº›ç€è¦½å™¨çš„é è¨­è¡Œç‚º
                
                const term = this.value; // å–å¾—è¼¸å…¥æ¡†çš„å€¼
                
                if (term.length > 0) {
                    // ä½¿ç”¨ JavaScript é€²è¡Œé é¢è·³è½‰
                    // encodeURIComponent æœƒè™•ç†ç©ºç™½ã€& ç¬¦è™Ÿç­‰ç‰¹æ®Šå­—å…ƒï¼Œé¿å…ç¶²å€å£æ‰
                    window.location.href = "{{ url_for('search') }}?q=" + encodeURIComponent(term);
                }
            }
        });

        document.querySelectorAll('pre code').forEach(code => {
            const match = code.className.match(/language-(\w+)/);
            if (!match) return;

            const lang = match[1];
            const pre = code.closest('pre');
            pre.setAttribute('data-lang', lang.toUpperCase());
        });
    </script>
</body>
</html>